{% extends "base.html" %}

{% load static %}
{% block title%}
New Post | DeThatBit
{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'review_board/review_board.css' %}" media="screen" />
{% endblock %}

{% block contents%}
<div class="content">
    <h1><a href="/free/">ReviewBoard</a></h1>
    <div class="contentBox_header"></div>
    <div class="contentBox_body">
        <div class="new_post my-5">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div>
                    <input type="text" class="album-select" name="album" placeholder="Album_Search" value="{{album}}">
                    <p id="album"></p>
                </div>
                <table>{{form.as_table}}</table>
                <div class="review_rating">
                    <div>Rating</div>
                    <div>
                         <input type="range" class="slider" type="range" min="0" max="10" step="0.5" value="5"
                            list="tickmarks" /> 
                            <datalist id="tickmarks">
                                <option value="0"></option>
                                <option value="2"></option>
                                <option value="4"></option>
                                <option value="6"></option>
                                <option value="8"></option>
                                <option value="10"></option>
                              </datalist>
                            <span class="rating_num">⭐5</span>
                    </div>
                </div>

                <button class="btn btn-info mt-3" type="submit"> Submit </button>
                <button onclick="location.href='../'">Back</button>
            </form>

            <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
            <script type="text/javascript">
                const slider = document.querySelector(".slider");
                slider.oninput = function () {
                    const output = document.querySelector(".rating_num");
                    rangeMax = this.value;
                    output.innerHTML = `⭐${this.value}`;
                }
                let tmp = location.href.split('?')

                if (tmp.length > 1) {
                    console.log(tmp[1])
                    let tmp1 = tmp[1].split(':')
                    console.log(tmp1[1])
                    document.getElementsByClassName("album-select")[0].value = tmp1[1]
                }

                let old = ""

                function albumClick(e) {
                    e.preventDefault()
                    //console.log(e.target.innerText)

                    document.getElementsByClassName("album-select")[0].value = e.target.innerText
                    //console.log(k)
                }

                $(".album-select").on("propertychange change keyup paste input", function () {
                    const now = $(this).val();
                    if (now == "") {
                        return;
                    }
                    if (now == old) {
                        return;
                    }
                    console.log(now)
                    // 여기까진 값이 바뀔때마다 인식하는 부분
                    const reset = document.getElementById('album-list')
                    console.log("지운거", reset)
                    if (reset) {
                        document.getElementById('album').removeChild(reset)
                    }
                    $.ajax({
                        type: "POST",
                        url: "{% url 'album_select' %}",
                        data: { 'q': now, 'csrfmiddlewaretoken': '{{ csrf_token }}' },
                        dataType: "json",
                        success: function (response) {
                            if (now !== $(".album-select").val()) {
                                return
                            }
                            if (response.album_select == "") {
                                return
                            }
                            album_select = response.album_select.split('\n')
                            let list = document.createElement('ul')
                            list.id = "album-list"
                            album_select.forEach(element => {
                                //console.log(element)
                                let li = document.createElement('li')
                                let btn = document.createElement('button')
                                btn.innerText = element
                                btn.addEventListener("click", albumClick)
                                li.appendChild(btn)
                                list.appendChild(li)
                            });
                            console.log(list)
                            document.getElementById('album').appendChild(list);
                            //$("#album").html(response.album_select);
                            //console.log(album_select)
                        },
                        error: function (request, status, error) {
                            alert("Fail")
                            window.location.replace("")
                        },
                    });
                    old = now
                })
            </script>
        </div>
    </div>
</div>

{% endblock %}